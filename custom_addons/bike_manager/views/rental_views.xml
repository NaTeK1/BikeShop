<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <!-- Vue liste Locations -->
    <record id="view_bike_rental_tree" model="ir.ui.view">
        <field name="name">bike.rental.tree</field>
        <field name="model">bike.rental</field>
        <field name="arch" type="xml">
            <list string="Locations"
                  decoration-info="state=='draft'"
                  decoration-warning="state=='ongoing'"
                  decoration-success="state=='returned'"
                  decoration-muted="state=='cancelled'">
                <field name="name" width="11"/>
                <field name="customer_id" width="11"/>
                <field name="bike_item_id" width="11"/>
                <field name="product_id" width="11" optional="hide" string="Modèle"/>
                <field name="start_date" width="11"/>
                <field name="end_date" width="11"/>
                <field name="pricing_type" width="11"/>
                <field name="total_amount" width="11"/>
                <field name="state" width="11"/>
                <field name="is_paid" width="11"/>
            </list>
        </field>
    </record>

    <!-- Vue formulaire Location -->
    <record id="view_bike_rental_form" model="ir.ui.view">
        <field name="name">bike.rental.form</field>
        <field name="model">bike.rental</field>
        <field name="arch" type="xml">
            <form string="Location">
                <header>
                    <button name="action_start_rental" string="Démarrer la location" type="object"
                            class="oe_highlight" invisible="state != 'draft'"/>
                    <button name="action_return_bike" string="Retour du vélo" type="object"
                            class="oe_highlight" invisible="state != 'ongoing'"/>
                    <button name="action_cancel" string="Annuler" type="object"
                            invisible="state not in ['draft', 'ongoing']"/>
                    <button name="action_set_draft" string="Remettre en brouillon" type="object"
                            invisible="state != 'cancelled'"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,ongoing,returned"/>
                </header>

                <sheet>
                    <!-- TITRE -->
                    <div class="oe_title">
                        <h1>
                            <span invisible="name != 'New'">Nouvelle location</span>
                            <field name="name" readonly="1" invisible="name == 'New'"/>
                        </h1>
                    </div>

                    <!-- CLIENT + VÉLO -->
                    <group string="DÉTAIL">
                        <group>
                            <field name="customer_id" readonly="state != 'draft'"/>
                            <field name="bike_item_id" readonly="state != 'draft'"
                                   options="{'no_create': True}"/>
                            <field name="product_id" readonly="1" force_save="0"
                                   string="Modèle"/>
                        </group>
                    </group>

                    <!-- PÉRIODE -->
                    <group string="Période">
                        <group>
                            <!-- 1) Choix type -->
                            <field name="pricing_type" readonly="state != 'draft'"/>

                            <!-- 2) Durée selon type (dropdowns) -->
                            <field name="hours_qty"
                                   string="Durée (heures)"
                                   readonly="state != 'draft'"
                                   invisible="pricing_type != 'hourly'"/>
                            <field name="days_qty"
                                   string="Durée (jours)"
                                   readonly="state != 'draft'"
                                   invisible="pricing_type != 'daily'"/>
                            <field name="weeks_qty"
                                   string="Durée (semaines)"
                                   readonly="state != 'draft'"
                                   invisible="pricing_type != 'weekly'"/>
                            <field name="months_qty"
                                   string="Durée (mois)"
                                   readonly="state != 'draft'"
                                   invisible="pricing_type != 'monthly'"/>

                            <field name="start_date" readonly="state != 'draft'"/>
                            <field name="end_date" readonly="1"/>
                        </group>
                    </group>

                    <!-- TARIFICATION -->
                    <group string="Tarification">
                        <group>
                            <!-- Prix unitaire avec suffixe selon le type -->
                            <label for="unit_price" string="Prix unitaire - Horaire" invisible="pricing_type != 'hourly'"/>
                            <label for="unit_price" string="Prix unitaire - Journalier" invisible="pricing_type != 'daily'"/>
                            <label for="unit_price" string="Prix unitaire - Hebdomadaire" invisible="pricing_type != 'weekly'"/>
                            <label for="unit_price" string="Prix unitaire - Mensuel" invisible="pricing_type != 'monthly'"/>
                            <field name="unit_price" nolabel="1" readonly="state != 'draft'"/>

                            <!-- Caution -->
                            <label for="deposit_amount" string="Prix caution"/>
                            <field name="deposit_amount" nolabel="1" readonly="state != 'draft'"/>

                            <!-- Accessoires + frais manuels (uniquement en cours) -->
                            <field name="extra_product_ids"
                                widget="many2many_tags"
                                domain="[('can_be_rented','=',False)]"
                                invisible="state != 'ongoing'"/>
                            <field name="extras_total" readonly="1" invisible="state != 'ongoing'"/>
                            <field name="manual_extra_amount" invisible="state != 'ongoing'" groups="bike_manager.group_bike_manager"/>

                            <!-- Total -->
                            <label for="total_amount" string="Prix total"/>
                            <field name="total_amount" nolabel="1" readonly="1" class="oe_subtotal_footer_separator"/>
                        </group>

                        <!-- Résumé des frais (uniquement retournée) -->
                        <group string="Frais supplémentaires" invisible="state != 'returned'" groups="bike_manager.group_bike_manager">
                            <group>
                                <field name="extras_total" readonly="1"/>
                                <field name="manual_extra_amount" readonly="1"/>
                                <field name="extras_grand_total" readonly="1" class="oe_subtotal_footer_separator"/>
                            </group>
                        </group>
                    </group>

                    <!-- PAIEMENT -->
                    <group string="Paiement">
                        <group>
                            <field name="payment_method" readonly="state == 'cancelled'"/>
                            <field name="is_paid" invisible="state != 'returned'" groups="bike_manager.group_bike_manager"/>
                            <field name="deposit_returned" invisible="state != 'returned'" groups="bike_manager.group_bike_manager"/>
                        </group>
                    </group>

                    <!-- ÉTAT DU VÉLO -->
                    <group string="État du vélo" groups="bike_manager.group_bike_manager">
                        <group>
                            <field name="condition_on_pickup"
                                   placeholder="Décrivez l'état du vélo lors du retrait..."
                                   readonly="state != 'draft'"/>
                            <field name="condition_on_return"
                                   placeholder="Décrivez l'état du vélo lors du retour..."
                                   invisible="state != 'returned'"/>
                        </group>
                    </group>

                    <field name="invoice_id" invisible="1"/>
                </sheet>

                <!-- Facturation -->
                <div class="oe_button_box" name="button_box" groups="bike_manager.group_bike_manager">
                    <button name="action_create_invoice" type="object" class="oe_stat_button"
                            icon="fa-file-text-o" invisible="invoice_id">
                        <div class="o_stat_info">
                            <span class="o_stat_text">Créer facture</span>
                        </div>
                    </button>

                    <button name="action_view_invoice" type="object" class="oe_stat_button"
                            icon="fa-eye" invisible="not invoice_id">
                        <div class="o_stat_info">
                            <span class="o_stat_text">Voir facture</span>
                        </div>
                    </button>
                    <!-- Imprimer désactivé -->
                </div>

            </form>
        </field>
    </record>

    <!-- Vue calendrier Locations -->
    <record id="view_bike_rental_calendar" model="ir.ui.view">
        <field name="name">bike.rental.calendar</field>
        <field name="model">bike.rental</field>
        <field name="arch" type="xml">
            <calendar string="Locations" date_start="start_date" date_stop="end_date"
                      color="product_id" mode="month">
                <field name="customer_id"/>
                <field name="product_id"/>
            </calendar>
        </field>
    </record>

    <!-- Vue recherche Locations -->
    <record id="view_bike_rental_search" model="ir.ui.view">
        <field name="name">bike.rental.search</field>
        <field name="model">bike.rental</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="customer_id"/>
                <field name="product_id"/>
            </search>
        </field>
    </record>

    <!-- Action Locations -->
    <record id="action_bike_rental" model="ir.actions.act_window">
        <field name="name">Locations</field>
        <field name="res_model">bike.rental</field>
        <field name="view_mode">list,form,calendar</field>
        <field name="search_view_id" ref="view_bike_rental_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Créez votre première location
            </p>
            <p>
                Gérez les locations de vélos : tarifs, disponibilités et contrats.
            </p>
        </field>
    </record>

</odoo>
